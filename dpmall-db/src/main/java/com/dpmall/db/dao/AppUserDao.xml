<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.AppUserDao">
	<resultMap id="AppUserResultMap" type="com.dpmall.db.bean.AppUserEntity">
	    <id property="id" column="PK" />
	    <result property="username" column="P_USERNAME" />
	    <result property="password" column="P_PASSWD" />
	    <result property="cnName" column="P_CNNAME" />
	    <result property="roleCode" column="p_rolecode" />
	    <result property="agencyId" column="P_AGENCY" />
	    <result property="storeId" column="P_STORE" />
	    <result property="storeName" column="storeName"/>
	    <result property="storeAddress" column="storeAddress"/>
	    <result property="telePhone" column="P_TELEPHONE"/>
	</resultMap>
	
	<select id="login" resultMap="AppUserResultMap" >
		select a.*,a2.p_rolecode from APPUSER a,approle a2  where a.p_role=a2.pk and  a.p_username=#{username} and a.P_PASSWD=#{passwd}
	</select>
	
	<insert id="createStoreUser">
		insert into APPUSER (PK,P_USERNAME,P_PASSWD,P_CNNAME,P_ROLE,P_AGENCY,P_STORE) values(${user.id},#{user.username},#{user.password},#{user.cnName},${user.roleCode},${user.agencyId},${user.storeId})
	</insert>
	
	<update id="updateUser">
		update APPUSER 
		<set>
			<if test="user.password!=null">
				P_PASSWD=#{user.password},
			</if>
			<if test="user.cnName!=null">
				P_CNNAME=#{user.cnName},
			</if>
			<if test="user.roleCode!=null">
				P_ROLE=${user.roleCode},
			</if>
			<if test="user.agencyId!=null">
				P_AGENCY=${user.agencyId},
			</if>
			<if test="user.storeId!=null">
				P_STORE=${user.storeId},
			</if>
			where p_username=${user.id}
		</set>
	</update>
	
	<select id="getStoreAllUser" resultMap="AppUserResultMap">
		select * from APPUSER where p_store=${storeId}
	</select>
	
	<update id="changePassword">
		update appuser set p_passwd=#{password} where pk=#{id} and p_passwd=#{oldPassword}
	</update>
	<select id="getAgencyUserInfo" resultMap="AppUserResultMap">
		SELECT
			A .pk,
			A .P_CNNAME,
			A .P_TELEPHONE,
			a2.P_NAME AS storeName,
			A3.P_STREETNAME AS storeAddress
		FROM
			APPUSER A,
			AGENCY a2,
			ADDRESSES a3
		WHERE
			A .P_AGENCY = a2.PK
		AND a2.PK = A3.OWNERPKSTRING
		AND A .PK = #{id}
		AND ROWNUM = 1
	</select>
	<select id="getStoreUserInfo" resultMap="AppUserResultMap">
		SELECT
			A .PK,
			A .P_CNNAME,
			A .P_TELEPHONE,
			p.P_DISPLAYNAME as storeName,
			P_FORMATADDRESS AS storeAddress
		FROM
			APPUSER A,
			POINTOFSERVICE P
		WHERE
			A .P_STORE = P .PK
			AND A .PK = #{id}
	</select>
</mapper>