<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.PrePayDao">

	<resultMap id="prePayResultMap" type="com.dpmall.db.bean.PrePayEntity">
	    <id property="id" column="PK" />
	    <result property="recommendStore" column="P_RECOMMENDSTORE" />
	    <result property="consignment" column="P_CONSIGNMENT" />
	    <result property="cusComment" column="P_CUSCOMMET"/>
	    <result property="serverComment" column="P_SERVERCOMMENT"/>
	    <result property="cusRefuseComment" column="P_CUSREFUSECOMMET"/>
	    <result property="agencyComment" column="P_AGENCYCOMMENT"/>
	    <result property="refuseType" column="P_REFUSETYPE"/>
	    <result property="refuseComment" column="P_REFUSECOMMENT"/>
	    <result property="acceptedRefuseComment" column="P_ACCEPTEDREFUSECOMMENT"/>
	    <result property="deliverPic" column="P_DELIVERYPIC"/>
	    <result property="status" column="P_STATUS"/>
	    <result property="acceptedBy" column="P_ACCEPTEDBY"/>
	    <result property="acceptedComment" column="P_ACCEPTEDCOMMENT"/>
	    <result property="acceptedTime" column="P_ACCEPTEDTIME"/>
	    <result property="isDeliverySelf" column="P_ISDELIVERYSELF"/>
	    <result property="deliveryTime" column="P_DELIVERYTIME"/>
	    <result property="finishTime" column="P_FINISHTIME"/>
	    <result property="deliveryPoint" column="deliveryPoint"/>
	    <result property="deliveryMode" column="deliveryMode"/>
	    <result property="orderCode" column="p_code"/>
	    <result property="address" column="p_streetname"/>
	    <result property="orderTotal" column="p_payamount"/>
	    <result property="allocatCode" column="P_ALLOCATIONEMPLOYEECODE"/>
	    <result property="shippingAddress" column="P_SHIPPINGADDRESS"/>
	    <result property="buyerNick" column="P_BUYERNICK"/>
	    <result property="productCode" column="P_ICODE"/>
	    <result property="productCategory" column="P_CATEGORY"/>
	    <result property="productQuantity" column="P_QUANTITY"/>
	    <result property="productBaseprice" column="P_BASEPRICE"/>
	    <result property="productTotal" column="P_TOTALPRICE"/>
	    <result property="firstName" column="P_FIRSTNAME"/>
	    <result property="phone1" column="P_PHONE1"/>
	    <result property="consignmentCode" column="P_CCODE"/>
	    <result property="logisticsInfo" column="P_LOGISTICSINFO"/>
	    <result property="logisticsCompany" column="P_LOGISTICSCOMPANY"/>
	    <result property="trackingId" column="P_TRACKINGID"/>
	    <result property="deliveryCost" column="P_DELIVERYCOST"/>
	    <result property="salesApplication" column="P_SALESAPPLICATION"/>
	    <result property="juntanPrice" column="P_JUNTANPRICE"/>
	    <result property="payAmount" column="P_PAYAMOUNT"/>
	    <result property="serviceAmount" column="P_SERVICEAMOUNT"/>
	    <result property="deliveryMethods" column="P_DELIVERYMETHODS"/>
	    <result property="name" column="P_NAME"/>
	    <collection property="items" ofType="com.dpmall.db.bean.OrderItemEntity">
	    	<id property="id" column="itemsId"/>
		    <result property="splitOrderType" column="splitOrderType"/>
			<result property="packQua" column="packQua"/>
			<result property="code" column="code"/>
			<result property="name" column="name"/>
			<result property="description" column="description"/>
			<result property="category" column="category"/>
			<result property="unit" column="unit"/>
			<result property="netWeight" column="netWeight"/>
			<result property="volume" column="volume"/>
			<result property="size" column="size"/>
			<result property="quantity" column="quantity"/>
			<result property="tmallQuantity" column="tmallQuantity"/>
			<result property="basePrice" column="basePrice"/>
			<result property="totalPrice" column="totalPrice"/>
			<result property="deliveryCost" column="deliveryCost"/>
			<result property="promotionTotalsaved" column="promotionTotalsaved"/>
			<result property="payAmount" column="payAmount"/>
			<result property="juntanPrice" column="juntanPrice"/>
			<result property="serviceAmount" column="serviceAmount"/>
	    </collection>
	    
	</resultMap>
	
	<resultMap type="com.dpmall.db.bean.OrderEntity" id="listResultMap">
		<id property="id" column="pk"/>
		<result property="consignment" column="p_code"/>
		<result property="status" column="P_STATUS"/>
		<result property="clientName" column="P_FIRSTNAME"/>
		<result property="clientTel" column="p_phone1"/>
		<result property="address" column="P_STREETNAME"/>
		<result property="deliveryPoint" column="P_DELIVERYPOINTOFSERVICE"/>
			<collection property="items" ofType="com.dpmall.db.bean.OrderItemEntity">
				<id property="id" column="itemsId"/>
			    <result property="splitOrderType" column="splitOrderType"/>
				<result property="packQua" column="packQua"/>
				<result property="code" column="code"/>
				<result property="name" column="name"/>
				<result property="description" column="description"/>
				<result property="category" column="category"/>
				<result property="unit" column="unit"/>
				<result property="netWeight" column="netWeight"/>
				<result property="volume" column="volume"/>
				<result property="size" column="size"/>
				<result property="quantity" column="quantity"/>
				<result property="tmallQuantity" column="tmallQuantity"/>
				<result property="basePrice" column="basePrice"/>
				<result property="totalPrice" column="totalPrice"/>
				<result property="deliveryCost" column="deliveryCost"/>
				<result property="promotionTotalsaved" column="promotionTotalsaved"/>
				<result property="payAmount" column="payAmount"/>
				<result property="juntanPrice" column="juntanPrice"/>
				<result property="serviceAmount" column="serviceAmount"/>
		    </collection>
	</resultMap>
	
	<select id="get2DistributeCount" resultType="java.lang.Integer">
		SELECT
				COUNT (1)
			FROM
				CONSIGNMENTS c,
				ENUMERATIONVALUES E,
				COMPOSEDTYPES c2
			WHERE
				c.P_STATUS = E .PK
			AND E .TYPEPKSTRING = c2.PK
			<if test='status=="1"'>
				AND E.code ='DISTRIBUTED'
			</if>
			<if test='status=="2"'>
				AND E.code in ('ALLOCATED','BOOKED','SHIPPED','DPRECEIVE','STOREWAIT')
			</if>
			<if test='status=="3"'>
				AND E.code ='DPRECEIVE'
			</if>
			<if test='status=="4"'>
				AND E.code ='COMPLETED'
			</if>
				AND c.P_ALLOCATIONEMPLOYEECODE = #{distributorId}
	</select>
	<select id="get2StoreCount" resultType="java.lang.Integer">
		SELECT
				COUNT (1)
			FROM
				CONSIGNMENTS c,
				ENUMERATIONVALUES E,
				COMPOSEDTYPES c2
			WHERE
				c.P_STATUS = E .PK
			AND E .TYPEPKSTRING = c2.PK
			<if test='status=="1"'>
				AND E.code in ('DISTRIBUTED','STOREWAIT')
			</if>
			<if test='status=="2"'>
				AND E.code in ('ALLOCATED','BOOKED','SHIPPED','DPRECEIVE')
			</if>
			<if test='status=="3"'>
				AND E.code ='COMPLETED'
			</if>
				AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	<!--特权定金发单\下派    -->
	<update id="distribute">
		UPDATE CONSIGNMENTS
		SET 
		  P_DELIVERYPOINTOFSERVICE = #{storeId},
		  P_STATUS = (SELECT t2.pk FROM COMPOSEDTYPES t1,ENUMERATIONVALUES t2 
		  where t1.INTERNALCODe = 'ConsignmentStatus' and t2.TYPEPKSTRING = t1.PK 
          AND CODE='ALLOCATED')
		WHERE
			P_CODE = #{orderCode}
	</update>
	
	<update id="distributeO2o">
		UPDATE O2OCONSIGNMENTITEMS
		SET 
		  P_AGENCYCOMMENT = #{remark} 
		WHERE
			P_CONSIGNMENT = 
			(
				SELECT
					pk
				FROM
					CONSIGNMENTS
				WHERE
					P_CODE = #{orderCode}
			)
	</update>
	
	<!-- 特权定金导购员状态条数 -->
	<select id="get2AcceptorCount" resultType="int">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS
		WHERE
			1 = 1
		<if test="acceptorId != null">
		AND PK IN (
			SELECT
				P_CONSIGNMENT
			FROM
				O2OCONSIGNMENTITEMS
			WHERE 
			    P_ACCEPTEDBY = #{acceptorId}
		)
		</if>
		AND P_STATUS IN (
			SELECT
				t2.pk
			FROM
				COMPOSEDTYPES t1,
				ENUMERATIONVALUES t2
			WHERE
				t1.INTERNALCODe = 'ConsignmentStatus'
			AND t2.TYPEPKSTRING = t1.PK
			AND code IN (
				#{status}
			)
		)
	</select>
	<update id="updateOrder">
		UPDATE CONSIGNMENTS
			SET P_STATUS = "NVL" (
				(
					SELECT
						DISTINCT E .pk
					FROM
						CONSIGNMENTS c,
						ENUMERATIONVALUES E,
						COMPOSEDTYPES c3
					WHERE
						E .pk = c.p_status
					AND c3.pk = E .TYPEPKSTRING
					AND c3.INTERNALCODE = 'ConsignmentStatus'
					AND E .CODE = #{status})
				,
				P_STATUS
			)
			
			WHERE
				pk = #{orderCode}
	</update>
	<update id="updateO2oOrder">
		UPDATE O2OCONSIGNMENTITEMS
			SET P_AGENCYCOMMENT = #{remark}
			WHERE
				P_CONSIGNMENT = (
					SELECT
						PK
					FROM
						CONSIGNMENTS
					WHERE
						pk = #{orderCode}
				)
	</update>
</mapper>