<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.AppOrderDao">
	<resultMap id="AppOrderResultMap" type="com.dpmall.db.bean.OrderEntity">
	    <id property="id" column="PK" />
	    <result property="recommendStore" column="P_RECOMMENDSTORE" />
	    <result property="consignment" column="P_CONSIGNMENT" />
	    <result property="cusComment" column="P_CUSCOMMET"/>
	    <result property="serverComment" column="P_SERVERCOMMENT"/>
	    <result property="cusRefuseComment" column="P_CUSREFUSECOMMET"/>
	    <result property="agencyComment" column="P_AGENCYCOMMENT"/>
	    <result property="refuseType" column="P_REFUSETYPE"/>
	    <result property="refuseComment" column="P_REFUSECOMMENT"/>
	    <result property="acceptedRefuseComment" column="P_ACCEPTEDREFUSECOMMENT"/>
	    <result property="deliverPic" column="P_DELIVERYPIC"/>
	    <result property="status" column="P_STATUS"/>
	    <result property="acceptedBy" column="P_ACCEPTEDBY"/>
	    <result property="acceptedComment" column="P_ACCEPTEDCOMMENT"/>
	    <result property="acceptedTime" column="P_ACCEPTEDTIME"/>
	    <result property="isDeliverySelf" column="P_ISDELIVERYSELF"/>
	    <result property="deliveryTime" column="P_DELIVERYTIME"/>
	    <result property="finishTime" column="P_FINISHTIME"/>
	    <result property="deliveryPoint" column="deliveryPoint"/>
	    <result property="deliveryMode" column="deliveryMode"/>
	    <result property="orderCode" column="p_code"/>
	    <result property="address" column="p_streetname"/>
	    <result property="orderTotal" column="p_payamount"/>
	    <result property="allocatCode" column="P_ALLOCATIONEMPLOYEECODE"/>
	    <result property="shippingAddress" column="P_SHIPPINGADDRESS"/>
	    <result property="buyerNick" column="P_BUYERNICK"/>
	    <result property="productCode" column="P_ICODE"/>
	    <result property="productCategory" column="P_CATEGORY"/>
	    <result property="productQuantity" column="P_QUANTITY"/>
	    <result property="productBaseprice" column="P_BASEPRICE"/>
	    <result property="productTotal" column="P_TOTALPRICE"/>
	    <result property="firstName" column="P_FIRSTNAME"/>
	    <result property="phone1" column="P_PHONE1"/>
	    <result property="consignmentCode" column="P_CCODE"/>
	    <result property="logisticsInfo" column="P_LOGISTICSINFO"/>
	    <result property="logisticsCompany" column="P_LOGISTICSCOMPANY"/>
	    <result property="trackingId" column="P_TRACKINGID"/>
	    <result property="deliveryCost" column="P_DELIVERYCOST"/>
	    <result property="salesApplication" column="P_SALESAPPLICATION"/>
	    <result property="juntanPrice" column="P_JUNTANPRICE"/>
	    <result property="payAmount" column="P_PAYAMOUNT"/>
	    <result property="serviceAmount" column="P_SERVICEAMOUNT"/>
	    <result property="deliveryMethods" column="P_DELIVERYMETHODS"/>
	    <result property="name" column="P_NAME"/>
	    <collection property="items" ofType="com.dpmall.db.bean.OrderItemEntity">
	    	<id property="id" column="itemsId"/>
		    <result property="splitOrderType" column="splitOrderType"/>
			<result property="packQua" column="packQua"/>
			<result property="code" column="code"/>
			<result property="name" column="name"/>
			<result property="description" column="description"/>
			<result property="category" column="category"/>
			<result property="unit" column="unit"/>
			<result property="netWeight" column="netWeight"/>
			<result property="volume" column="volume"/>
			<result property="size" column="size"/>
			<result property="quantity" column="quantity"/>
			<result property="tmallQuantity" column="tmallQuantity"/>
			<result property="basePrice" column="basePrice"/>
			<result property="totalPrice" column="totalPrice"/>
			<result property="deliveryCost" column="deliveryCost"/>
			<result property="promotionTotalsaved" column="promotionTotalsaved"/>
			<result property="payAmount" column="payAmount"/>
			<result property="juntanPrice" column="juntanPrice"/>
			<result property="serviceAmount" column="serviceAmount"/>
	    </collection>
	    
	</resultMap>
	
	<select id="get2DistributeCount" resultType="java.lang.Integer">
		SELECT count(1) FROM CONSIGNMENTS c LEFT JOIN AGENCY A ON c.P_ALLOCATIONEMPLOYEECODE = A .p_uid WHERE 1=1
		<if test="distributorId != null">
			AND A.p_uid = #{distributorId}
		</if>
		<if test="status != null">
			AND c.P_STATUS=#{status}
		</if>	
	</select>
	
	<select id="get2AcceptCount" resultType="int">
		select count(1) from O2OCONSIGNMENTITEMS  where P_STATUS='10'
		<if test="storeId != null">
		    and P_RECOMMENDSTORE=${storeId}
		</if>
	</select>
	<!--经销商发单\下派   （O2O）  -->
	<update id="distribute4O2o">
		UPDATE O2OCONSIGNMENTITEMS
		SET 
		  P_AGENCYCOMMENT = #{remark},
		  P_RECOMMENDSTORE = #{storeId}
		WHERE
			P_CONSIGNMENT = 
		(
				SELECT
					pk
				FROM
					CONSIGNMENTS
				WHERE
					P_CODE = #{orderCode}
			)
	</update>
	
	<!--经销商发单\下派   （Consignment）  -->
	<update id="distribute4Consignment">
		update CONSIGNMENTS
		SET  
			P_STATUS = '8796105375835',  
			P_DELIVERYPOINTOFSERVICE = #{storeId}
		WHERE 
			P_CODE = #{orderCode}
	</update>
	
	
	<select id="getOnePage4Followup"  resultMap="AppOrderResultMap">
		select 
			C.PK,
			C.P_STATUS,
            C.P_ALLOCATIONEMPLOYEECODE as P_ALLOCATIONEMPLOYEECODE,
            C.P_SHIPPINGADDRESS as P_SHIPPINGADDRESS,
			O.P_CODE,
			O.P_BUYERNICK as P_BUYERNICK,
            O2O.P_RECOMMENDSTORE,
            O2O.P_CUSCOMMET,
            O2O.P_SERVERCOMMENT,
            O2O.P_AGENCYCOMMENT,
            P.P_CODE as P_ICODE,
            P.P_CATEGORY as P_CATEGORY,
            OE.P_QUANTITY as P_QUANTITY,
            OE.P_BASEPRICE as P_BASEPRICE,
            OE.P_TOTALPRICE as P_TOTALPRICE,
			ROWNUM RN
		from CONSIGNMENTS C LEFT JOIN ORDERS O ON O.PK=C.P_ORDER
		LEFT JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		LEFT JOIN ORDERENTRIES OE ON OE.P_ORDER=O.PK
		LEFT JOIN PRODUCTS P ON OE.P_PRODUCT=P.PK 
		where 1= 1 AND C.P_STATUS in ('8796105375835','8796105670747','8796105375835')
		<if test="distributorId != null">
		    AND C.P_ALLOCATIONEMPLOYEECODE = #{distributorId} 
		</if>
		AND  ROWNUM between ${offset} and ${pageSize}
	</select>
	
	<select id="getOnePage4Accept"  resultMap="AppOrderResultMap">
		select 
			C.PK,
			C.P_STATUS,
            OE.P_QUANTITY as P_QUANTITY,
            OE.P_PAYAMOUNT as p_payamount,
            AD.P_FIRSTNAME as P_FIRSTNAME,
            AD.P_PHONE1 as P_PHONE1,
            AD.P_STREETNAME as p_streetname,
			ROWNUM RN
		from CONSIGNMENTS C LEFT JOIN ORDERS O ON O.PK=C.P_ORDER
		LEFT JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		LEFT JOIN ORDERENTRIES OE ON OE.P_ORDER=O.PK
		LEFT JOIN ADDRESSES AD ON C.P_SHIPPINGADDRESS=AD.PK 
		where 1= 1 AND C.P_STATUS = '8796105637979'
		<if test="storeId != null">
		    AND O2O.P_RECOMMENDSTORE = #{storeId} 
		</if>
		AND  ROWNUM between ${offset} and ${pageSize}
	</select>
	
	<!-- 更新O2O表 -->
	<update id="edit">
		UPDATE O2OCONSIGNMENTITEMS
		<set>
			<if test="entity.recommendStore !=null">
				P_RECOMMENDSTORE = #{entity.recommendStore},
			</if>
			<if test="entity.consignment !=null">
				P_CONSIGNMENT = #{entity.consignment},
			</if>
			<if test="entity.cusComment !=null">
				P_CUSCOMMET = #{entity.cusComment},
			</if>
			<if test="entity.serverComment !=null">
				P_SERVERCOMMENT = #{entity.serverComment},
			</if>
			<if test="entity.cusRefuseComment !=null">
				P_CUSREFUSECOMMET = #{entity.cusRefuseComment},
			</if>
			<if test="entity.agencyComment !=null">
				P_AGENCYCOMMENT = #{entity.agencyComment},
			</if>
			<if test="entity.refuseType !=null">
				P_REFUSETYPE = #{entity.refuseType},
			</if>
			<if test="entity.refuseComment !=null">
				P_REFUSECOMMENT = #{entity.refuseComment},
			</if>
			<if test="entity.acceptedRefuseComment !=null">
				P_ACCEPTEDREFUSECOMMENT = #{entity.acceptedRefuseComment},
			</if>
			<if test="entity.deliverPic !=null">
				P_DELIVERYPIC = #{entity.deliverPic},
			</if>
			<if test="entity.status !=null">
				P_STATUS = #{entity.status},
			</if>
			<if test="entity.acceptedBy !=null">
				P_ACCEPTEDBY = #{entity.acceptedBy},
			</if>
			<if test="entity.acceptedComment !=null">
				P_ACCEPTEDCOMMENT = #{entity.acceptedComment},
			</if>
			<if test="entity.acceptedTime !=null">
				P_ACCEPTEDTIME = #{entity.acceptedTime},
			</if>
			<if test="entity.isDeliverySelf !=null">
				P_ISDELIVERYSELF = #{entity.isDeliverySelf},
			</if>
			<if test="entity.deliveryTime !=null">
				P_DELIVERYTIME = #{entity.deliveryTime},
			</if>
			<if test="entity.finishTime !=null">
				P_FINISHTIME = ${entity.finishTime},
			</if>
			<if test="entity.deliveryPoint !=null">
				deliveryPoint = #{entity.deliveryPoint},
			</if>
			<if test="entity.deliveryMode !=null">
				deliveryMode = #{entity.deliveryMode},
			</if>
		</set>
		WHERE
			P_CONSIGNMENT = (
				SELECT
					pk
				FROM
					CONSIGNMENTS 
				WHERE
					P_CODE = #{entity.orderCode})
	</update>
	
	<!--更新表CONSIGNMENTS 收货状态  -->
		<update id="deliver4Consignments">
			UPDATE CONSIGNMENTS 
				<set>
					P_STATUS = '8796105670747',
					<if test="entity.deliveryTime != null">
						P_SHIPPINGDATE = #{entity.deliveryTime}
					</if>
				</set> 
				<if test="entity.orderCode != null">
					where P_CODE = #{entity.orderCode}
				</if>
		</update>
	
	<update id="accept">
		update O2OCONSIGNMENTITEMS set
		    P_STATUS='15',
		    P_ACCEPTEDTIME=sysdate,
			<if test="acceptorId!=null">
				P_ACCEPTEDBY=#{acceptorId},
			</if>
			<if test="acceptComment!=null">
				P_ACCEPTEDCOMMENT=#{acceptComment}
			</if>
		where P_CONSIGNMENT=#{orderCode}
	</update>	
	
	<resultMap type="com.dpmall.db.bean.OrderEntity" id="listResultMap">
		<id property="id" column="pk"/>
		<result property="consignment" column="p_code"/>
		<result property="status" column="P_STATUS"/>
		<result property="clientName" column="P_FIRSTNAME"/>
		<result property="clientTel" column="p_phone1"/>
		<result property="address" column="P_STREETNAME"/>
			<collection property="items" ofType="com.dpmall.db.bean.OrderItemEntity">
				<id property="id" column="itemsId"/>
			    <result property="splitOrderType" column="splitOrderType"/>
				<result property="packQua" column="packQua"/>
				<result property="code" column="code"/>
				<result property="name" column="name"/>
				<result property="description" column="description"/>
				<result property="category" column="category"/>
				<result property="unit" column="unit"/>
				<result property="netWeight" column="netWeight"/>
				<result property="volume" column="volume"/>
				<result property="size" column="size"/>
				<result property="quantity" column="quantity"/>
				<result property="tmallQuantity" column="tmallQuantity"/>
				<result property="basePrice" column="basePrice"/>
				<result property="totalPrice" column="totalPrice"/>
				<result property="deliveryCost" column="deliveryCost"/>
				<result property="promotionTotalsaved" column="promotionTotalsaved"/>
				<result property="payAmount" column="payAmount"/>
				<result property="juntanPrice" column="juntanPrice"/>
				<result property="serviceAmount" column="serviceAmount"/>
		    </collection>
	</resultMap>
		
	<select id="getOnePage4Distribute" resultMap="listResultMap">
		SELECT
				*
			FROM
				(
					SELECT
						c.p_code,
						c.pk,
						o2.P_QUANTITY AS quantity,
						o2.P_TMALLQUANTITY AS tmallQuantity,
						o2.P_DELIVERYCOST AS deliveryCost,
						o2.P_SERVICEAMOUNT AS serviceAmount,
						o2.p_payamount AS payAmount,
						c.P_STATUS,
						o2.pk AS itemsId,
						o2.P_PAYAMOUNT,
						o2.P_JUNTANPRICE,
						A .P_FIRSTNAME,
						A .p_phone1,
						A .P_STREETNAME,
						U .P_CODE AS unit,
						ROWNUM rn
					FROM
						CONSIGNMENTS c
					LEFT JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
					LEFT JOIN ORDERENTRIES o2 ON c2.P_ORDERENTRY = o2.pk
					LEFT JOIN ADDRESSES A ON c.P_SHIPPINGADDRESS = A .pk
					LEFT JOIN UNITS U ON o2.P_UNIT = U .pk
					WHERE
						c.P_SPLITORDERTYPE like '%M%' and 
						c.P_ALLOCATIONEMPLOYEECODE = #{distributorId}
					AND c.P_STATUS = #{status}
					AND ROWNUM &lt; ${offset}+${pageSize}+1
				) p1 WHERE p1.rn&gt;${offset}
	</select>
	
	<select id="getOrderDetails"  resultMap="AppOrderResultMap">
		select 
   		      C.PK,
   		      C.P_CODE AS P_CCODE,
   		      C.P_STATUS,
   		      C.P_SHIPPINGADDRESS,
   		      C.P_LOGISTICSINFO,
   		      C.P_DELIVERYMODE as deliveryMode,
   		      C.P_LOGISTICSCOMPANY,
      		  C.P_TRACKINGID,
      		  O2O.P_CUSCOMMET,
   		      O2O.P_SERVERCOMMENT,
   		      O2O.P_AGENCYCOMMENT,
   		      O2O.P_ACCEPTEDBY,
		      O2O.P_ACCEPTEDCOMMENT,
   		      O2O.P_DELIVERYPIC,
   		      O.P_BUYERNICK,
   		      P.P_CATEGORY,
      		  P.P_CODE AS P_ICODE,
      		  OE.P_QUANTITY,
   		      OE.P_TMALLQUANTITY,
   		      OE.P_BASEPRICE,
   		      OE.P_TOTALPRICE,
   		      OE.P_DELIVERYCOST,
   
   		      O.P_SALESAPPLICATION,
   		      OE.P_JUNTANPRICE,
  		      OE.P_PAYAMOUNT,
      		  OE.P_SERVICEAMOUNT,
   
      		  LI.P_DELIVERYMETHODS,
   		      LI.P_NAME,
   		      A.P_STREETNAME,
  		      A.P_PHONE1,
   		      C.P_CATEGORY,
   		      ROWNUM RN
   		      from CONSIGNMENTS C 
   		  LEFT JOIN ADDRESSES A ON C.P_SHIPPINGADDRESS=A.PK
   		  LEFT JOIN LOGISTICSINFO LI ON C.P_LOGISTICSINFO=LI.PK
   		  LEFT JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
   		  LEFT JOIN ORDERS O ON C.P_ORDER=O.PK
   		  LEFT JOIN ORDERENTRIES OE ON OE.P_ORDER=O.PK
   		  LEFT JOIN PRODUCTS P ON OE.P_PRODUCT=P.PK
		<if test="consignmentId != null">
		  WHERE 1=1 AND C.P_CODE= #{consignmentId}
		</if>
	</select>
</mapper>