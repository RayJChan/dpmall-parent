<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.AppOrderDao">
	<resultMap id="AppOrderResultMap" type="com.dpmall.db.bean.OrderEntity">
	    <id property="id" column="PK" />
	    <result property="recommendStore" column="P_RECOMMENDSTORE" />
	    <result property="consignment" column="P_CONSIGNMENT" />
	    <result property="cusComment" column="P_CUSCOMMET"/>
	    <result property="serverComment" column="P_SERVERCOMMENT"/>
	    <result property="cusRefuseComment" column="P_CUSREFUSECOMMET"/>
	    <result property="agencyComment" column="P_AGENCYCOMMENT"/>
	    <result property="refuseType" column="P_REFUSETYPE"/>
	    <result property="refuseComment" column="P_REFUSECOMMENT"/>
	    <result property="acceptedRefuseComment" column="P_ACCEPTEDREFUSECOMMENT"/>
	    <result property="deliverPic" column="P_DELIVERYPIC"/>
	    <result property="status" column="P_STATUS"/>
	    <result property="acceptedBy" column="P_ACCEPTEDBY"/>
	    <result property="acceptedComment" column="P_ACCEPTEDCOMMENT"/>
	    <result property="acceptedTime" column="P_ACCEPTEDTIME"/>
	    <result property="isDeliverySelf" column="P_ISDELIVERYSELF"/>
	    <result property="deliveryTime" column="P_DELIVERYTIME"/>
	    <result property="finishTime" column="P_FINISHTIME"/>
	    <result property="deliveryPoint" column="deliveryPoint"/>
	    <result property="deliveryMode" column="deliveryMode"/>
	    <result property="orderCode" column="p_code"/>
	    <result property="address" column="p_streetname"/>
	    <result property="orderTotal" column="p_payamount"/>
	    <result property="allocatCode" column="P_ALLOCATIONEMPLOYEECODE"/>
	    <result property="shippingAddress" column="P_SHIPPINGADDRESS"/>
	    <result property="buyerNick" column="P_BUYERNICK"/>
	    <result property="productCode" column="P_ICODE"/>
	    <result property="productCategory" column="P_CATEGORY"/>
	    <result property="productQuantity" column="P_QUANTITY"/>
	    <result property="productBaseprice" column="P_BASEPRICE"/>
	    <result property="productTotal" column="P_TOTALPRICE"/>
	    <result property="firstName" column="P_FIRSTNAME"/>
	    <result property="phone1" column="P_PHONE1"/>
	</resultMap>
	
	<select id="get2DistributeCount" resultType="java.lang.Integer">
		SELECT
			count(1)
			FROM
				O2OCONSIGNMENTITEMS o
				LEFT JOIN CONSIGNMENTS c ON o.P_CONSIGNMENT = c.PK			
				LEFT JOIN AGENCY A ON c.P_ALLOCATIONEMPLOYEECODE = A .p_uid
				WHERE
					A .PK = ${distributorId}
					AND o.P_STATUS='0'					
	</select>
	<select id="get2AcceptCount" resultType="int">
		select count(1) from O2OCONSIGNMENTITEMS  where P_STATUS='10'
		<if test="storeId != null">
		    and P_RECOMMENDSTORE=${storeId}
		</if>
	</select>
	<update id="distribute">
		update O2OCONSIGNMENTITEMS set 
			P_RECOMMENDSTORE=#{storeId},
			P_STATUS='10'
		where pk=#{orderCode}
	</update>
	
	<select id="getOnePage4Distribute"  resultMap="AppOrderResultMap">
		select 
			C.PK,
			C.P_STATUS,
            C.P_ALLOCATIONEMPLOYEECODE as P_ALLOCATIONEMPLOYEECODE,
            C.P_SHIPPINGADDRESS as P_SHIPPINGADDRESS,
			O.P_CODE,
			O.P_BUYERNICK as P_BUYERNICK,
            O2O.P_RECOMMENDSTORE,
            O2O.P_CUSCOMMET,
            O2O.P_SERVERCOMMENT,
            O2O.P_AGENCYCOMMENT,
            P.P_CODE as P_ICODE,
            P.P_CATEGORY as P_CATEGORY,
            OE.P_QUANTITY as P_QUANTITY,
            OE.P_BASEPRICE as P_BASEPRICE,
            OE.P_TOTALPRICE as P_TOTALPRICE,
			ROWNUM RN
		from CONSIGNMENTS C LEFT JOIN ORDERS O ON O.PK=C.P_ORDER
		LEFT JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		LEFT JOIN ORDERENTRIES OE ON OE.P_ORDER=O.PK
		LEFT JOIN PRODUCTS P ON OE.P_PRODUCT=P.PK 
		where 1= 1 AND C.P_STATUS='8796105375835'
		<if test="distributorId != null">
		    AND C.P_ALLOCATIONEMPLOYEECODE = #{distributorId} 
		</if>
		AND  ROWNUM between ${offset} and ${pageSize}
	</select>
	
	
	<select id="getOnePage4Followup"  resultMap="AppOrderResultMap">
		select 
			C.PK,
			C.P_STATUS,
            C.P_ALLOCATIONEMPLOYEECODE as P_ALLOCATIONEMPLOYEECODE,
            C.P_SHIPPINGADDRESS as P_SHIPPINGADDRESS,
			O.P_CODE,
			O.P_BUYERNICK as P_BUYERNICK,
            O2O.P_RECOMMENDSTORE,
            O2O.P_CUSCOMMET,
            O2O.P_SERVERCOMMENT,
            O2O.P_AGENCYCOMMENT,
            P.P_CODE as P_ICODE,
            P.P_CATEGORY as P_CATEGORY,
            OE.P_QUANTITY as P_QUANTITY,
            OE.P_BASEPRICE as P_BASEPRICE,
            OE.P_TOTALPRICE as P_TOTALPRICE,
			ROWNUM RN
		from CONSIGNMENTS C LEFT JOIN ORDERS O ON O.PK=C.P_ORDER
		LEFT JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		LEFT JOIN ORDERENTRIES OE ON OE.P_ORDER=O.PK
		LEFT JOIN PRODUCTS P ON OE.P_PRODUCT=P.PK 
		where 1= 1 AND C.P_STATUS in ('8796105375835','8796105670747','8796105375835')
		<if test="distributorId != null">
		    AND C.P_ALLOCATIONEMPLOYEECODE = #{distributorId} 
		</if>
		AND  ROWNUM between ${offset} and ${pageSize}
	</select>
	
	<select id="getOnePage4Accept"  resultMap="AppOrderResultMap">
		select 
			C.PK,
			C.P_STATUS,
            OE.P_QUANTITY as P_QUANTITY,
            OE.P_PAYAMOUNT as p_payamount,
            AD.P_FIRSTNAME as P_FIRSTNAME,
            AD.P_PHONE1 as P_PHONE1,
            AD.P_STREETNAME as p_streetname,
			ROWNUM RN
		from CONSIGNMENTS C LEFT JOIN ORDERS O ON O.PK=C.P_ORDER
		LEFT JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		LEFT JOIN ORDERENTRIES OE ON OE.P_ORDER=O.PK
		LEFT JOIN ADDRESSES AD ON C.P_SHIPPINGADDRESS=AD.PK 
		where 1= 1 AND C.P_STATUS = '8796105637979'
		<if test="storeId != null">
		    AND O2O.P_RECOMMENDSTORE = #{storeId} 
		</if>
		AND  ROWNUM between ${offset} and ${pageSize}
	</select>
	
</mapper>